<!DOCTYPE html>
<html>
<head>
    <title>R2 ä¸Šä¼ æµ‹è¯•</title>
    <meta charset="UTF-8">
</head>
<body>
    <h1>R2 å®¢æˆ·ç«¯ç›´ä¼ æµ‹è¯•</h1>

    <input type="file" id="fileInput" accept=".csv">
    <button onclick="testUpload()">æµ‹è¯•ä¸Šä¼ </button>

    <div id="log" style="margin-top: 20px; padding: 10px; border: 1px solid #ccc; min-height: 200px; font-family: monospace; white-space: pre-wrap;"></div>

    <script>
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
        }

        async function testUpload() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];

            if (!file) {
                log('âŒ è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
                return;
            }

            log(`ğŸ“ é€‰æ‹©æ–‡ä»¶: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`);

            try {
                // æ­¥éª¤ 1: è·å–é¢„ç­¾å URL
                log('ğŸ”„ æ­¥éª¤ 1: è¯·æ±‚é¢„ç­¾å URL...');
                const urlResponse = await fetch('/api/get-upload-url', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        fileName: file.name,
                        fileSize: file.size,
                        contentType: file.type || 'text/csv',
                    }),
                });

                if (!urlResponse.ok) {
                    throw new Error(`è·å–ä¸Šä¼  URL å¤±è´¥: ${urlResponse.status}`);
                }

                const { uploadUrl, publicUrl, key } = await urlResponse.json();
                log(`âœ… è·å–åˆ°é¢„ç­¾å URL`);
                log(`   æ–‡ä»¶é”®: ${key}`);
                log(`   å…¬å…± URL: ${publicUrl}`);

                // æ­¥éª¤ 2: ç›´æ¥ä¸Šä¼ åˆ° R2
                log('ğŸ”„ æ­¥éª¤ 2: ä¸Šä¼ æ–‡ä»¶åˆ° R2...');
                log(`   ç›®æ ‡: ${uploadUrl.split('?')[0]}`);

                const uploadResponse = await fetch(uploadUrl, {
                    method: 'PUT',
                    body: file,
                    headers: {
                        'Content-Type': file.type || 'text/csv',
                    },
                });

                if (!uploadResponse.ok) {
                    const errorText = await uploadResponse.text();
                    throw new Error(`R2 ä¸Šä¼ å¤±è´¥: ${uploadResponse.status}\n${errorText}`);
                }

                log(`âœ… ä¸Šä¼ æˆåŠŸï¼`);
                log(`   æ–‡ä»¶å·²ä¿å­˜åˆ°: ${publicUrl}`);
                log(`\nğŸ‰ æµ‹è¯•å®Œæˆï¼`);

            } catch (error) {
                log(`âŒ é”™è¯¯: ${error.message}`);
                console.error(error);
            }
        }
    </script>
</body>
</html>
