<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV æ•°æ®åˆ†æå·¥ä½œå®¤</title>
    <!--
    âš ï¸ æœ¬åœ°ä½¿ç”¨æç¤ºï¼š
    å¦‚æœæ‚¨ç›´æ¥æ‰“å¼€æ­¤ HTML æ–‡ä»¶ï¼ŒAI åˆ†æåŠŸèƒ½å¯èƒ½æ— æ³•æ­£å¸¸å·¥ä½œã€‚

    æ¨èä½¿ç”¨æ–¹å¼ï¼š
    1. è®¿é—® Vercel çº¿ä¸Šç‰ˆæœ¬ï¼ˆæ¨èï¼‰:
       https://csv-visualizer-one.vercel.app

    2. æˆ–å¯åŠ¨æœ¬åœ°å¼€å‘æœåŠ¡å™¨:
       npm run dev
       ç„¶åè®¿é—® http://localhost:3000

    è¯¦ç»†è¯´æ˜è¯·æŸ¥çœ‹ï¼šæœ¬åœ°ä½¿ç”¨è¯´æ˜.md
    -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Merriweather:ital,wght@0,300;0,700;1,300&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        /* ==================== Claude Style Variables ==================== */
        :root {
            --bg-app: #F5F4F1;
            --bg-panel: #FFFFFF;
            --bg-sidebar: #EBEAE8;
            --text-primary: #2D2D2D;
            --text-secondary: #666666;
            --text-accent: #DA7756;
            --border-subtle: #E0E0E0;
            --shadow-card: 0 2px 8px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
            --shadow-float: 0 8px 24px rgba(0, 0, 0, 0.08);
            --radius-sm: 6px;
            --radius-md: 12px;
            --radius-lg: 18px;
            --font-serif: "Merriweather", "Georgia", serif;
            --font-sans: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        * {
            box-sizing: border-box;
        }

        body {
            background-color: var(--bg-app);
            color: var(--text-primary);
            font-family: var(--font-sans);
            margin: 0;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        /* ==================== Layout ==================== */
        .app-container {
            display: grid;
            grid-template-columns: 260px 1fr;
            min-height: 100vh;
        }

        /* ==================== Sidebar ==================== */
        .sidebar {
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 32px 24px 24px 24px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .sidebar-title {
            font-family: var(--font-serif);
            font-weight: 700;
            font-size: 1.3rem;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .sidebar-subtitle {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .nav-section {
            padding: 16px 0;
        }

        .nav-label {
            padding: 8px 24px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 24px;
            margin: 4px 12px;
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.95rem;
            gap: 12px;
        }

        .nav-item:hover {
            background-color: rgba(255, 255, 255, 0.5);
            color: var(--text-primary);
        }

        .nav-item.active {
            background-color: var(--bg-panel);
            color: var(--text-primary);
            font-weight: 600;
            box-shadow: var(--shadow-card);
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ==================== Main Content ==================== */
        .main-content {
            padding: 40px;
            overflow-y: auto;
            max-height: 100vh;
        }

        .view-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .view-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ==================== Upload Area ==================== */
        .upload-zone {
            background: var(--bg-panel);
            border: 2px dashed var(--border-subtle);
            border-radius: var(--radius-lg);
            padding: 60px 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 32px;
        }

        .upload-zone:hover, .upload-zone.highlight {
            border-color: var(--text-accent);
            background-color: rgba(218, 119, 86, 0.02);
        }

        .upload-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 20px;
            color: var(--text-secondary);
        }

        .upload-title {
            font-family: var(--font-serif);
            font-size: 1.3rem;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .upload-subtitle {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* ==================== Thread Viewer ==================== */
        .thread-viewer {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 32px;
            height: calc(100vh - 80px);
        }

        .thread-list {
            background: var(--bg-panel);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            overflow-y: auto;
            box-shadow: var(--shadow-card);
        }

        .thread-list-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-subtle);
            background: #FAFAFA;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .thread-list-title {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .thread-count {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* ==================== Filter Styles (Claude Style) ==================== */
        .filter-bar {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            border-bottom: 1px solid var(--border-subtle);
            background: #fff;
            position: relative; /* For popover positioning */
            overflow: hidden; /* Prevent overflow */
            z-index: 100; /* Ensure filter bar is above thread items */
        }

        .filter-trigger-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            background: #fff;
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            flex-shrink: 0; /* Prevent button from shrinking */
        }

        .filter-trigger-btn:hover, .filter-trigger-btn.active {
            background: #FAFAFA;
            color: var(--text-primary);
            border-color: var(--text-secondary);
        }

        .active-filters-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            flex: 1;
            min-width: 0; /* Allow shrinking */
            overflow: hidden; /* Prevent chips from overflowing */
        }

        .filter-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: rgba(218, 119, 86, 0.08);
            border: 1px solid rgba(218, 119, 86, 0.2);
            border-radius: 100px;
            font-size: 0.8rem;
            color: var(--text-accent);
            font-weight: 500;
            animation: fadeIn 0.2s ease;
            max-width: 300px; /* Limit chip width */
            flex-shrink: 0; /* Prevent shrinking */
        }

        .filter-chip-label {
            color: var(--text-secondary);
            margin-right: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px; /* Truncate long values */
        }

        .filter-chip-remove {
            cursor: pointer;
            color: var(--text-accent);
            opacity: 0.7;
            display: flex;
            align-items: center;
            transition: opacity 0.2s;
        }

        .filter-chip-remove:hover {
            opacity: 1;
        }

        /* Filter Panel (Popover) */
        .filter-panel {
            position: absolute;
            top: 48px;
            left: 20px;
            width: 320px;
            background: #fff;
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-float);
            z-index: 1000; /* High z-index to float above other UI elements */
            display: none;
            flex-direction: column;
            overflow: hidden;
            animation: slideDown 0.2s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .filter-panel.active {
            display: flex;
        }

        .filter-panel-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-subtle);
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #FAFAFA;
            color: var(--text-primary);
        }

        .icon-btn {
            background: none;
            border: none;
            padding: 4px;
            cursor: pointer;
            color: var(--text-secondary);
            border-radius: 4px;
            display: flex;
            align-items: center;
        }

        .icon-btn:hover {
            background: rgba(0,0,0,0.05);
            color: var(--text-primary);
        }

        .filter-panel-body {
            padding: 0;
            max-height: 400px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        /* Field List */
        .field-list {
            list-style: none;
            padding: 8px 0;
            margin: 0;
        }

        .field-group-label {
            padding: 8px 16px 4px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .field-item {
            padding: 8px 16px 8px 24px;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.1s;
        }

        .field-item:hover {
            background: #F5F5F5;
        }

        /* Value Selection */
        .filter-back-header {
            padding: 8px 16px;
            border-bottom: 1px solid var(--border-subtle);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            background: #fff;
        }

        .filter-back-header:hover {
            color: var(--text-primary);
            background: #FAFAFA;
        }

        .value-search {
            padding: 10px 16px;
            border-bottom: 1px solid var(--border-subtle);
            background: #fff;
            position: sticky;
            top: 0;
        }

        .value-search input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            font-size: 0.85rem;
            outline: none;
            transition: border-color 0.2s;
        }

        .value-search input:focus {
            border-color: var(--text-accent);
            box-shadow: 0 0 0 2px rgba(218, 119, 86, 0.1);
        }

        .value-list {
            padding: 0;
            margin: 0;
            list-style: none;
        }

        .value-item {
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: background 0.1s;
        }

        .value-item:hover {
            background: #FAFAFA;
        }

        .value-checkbox {
            accent-color: var(--text-accent);
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .value-count {
            margin-left: auto;
            font-size: 0.75rem;
            color: var(--text-secondary);
            background: #F0F0F0;
            padding: 2px 6px;
            border-radius: 8px;
        }

        .filter-panel-footer {
            padding: 12px 16px;
            border-top: 1px solid var(--border-subtle);
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            background: #FAFAFA;
        }

        .thread-item {
            padding: 16px 20px;
            border-bottom: 1px solid #F5F5F5;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'SF Mono', 'Menlo', 'Consolas', monospace;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .thread-item:hover {
            background: #FAFAFA;
            color: var(--text-primary);
        }

        .thread-item.active {
            background: rgba(218, 119, 86, 0.08);
            color: var(--text-accent);
            border-left: 3px solid var(--text-accent);
        }

        .thread-content {
            background: var(--bg-panel);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: 32px;
            overflow-y: auto;
            box-shadow: var(--shadow-card);
        }

        .thread-header {
            margin-bottom: 32px;
            padding-bottom: 20px;
            border-bottom: 2px solid #F5F5F5;
        }

        .thread-id-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-secondary);
            font-weight: 600;
            margin-bottom: 8px;
        }

        .thread-id-value {
            font-family: 'SF Mono', 'Menlo', 'Consolas', monospace;
            font-size: 1rem;
            color: var(--text-accent);
            background: rgba(218, 119, 86, 0.08);
            padding: 12px 16px;
            border-radius: var(--radius-sm);
            display: inline-block;
            cursor: pointer;
            transition: background 0.2s;
        }

        .thread-id-value:hover {
            background: rgba(218, 119, 86, 0.15);
        }

        .message-card {
            background: #FFFFFF;
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-card);
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #F5F5F5;
        }

        .message-meta {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .turn-badge {
            background: #F0F0F0;
            color: var(--text-secondary);
            padding: 4px 12px;
            border-radius: 100px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .timestamp {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .message-text {
            font-size: 0.95rem;
            line-height: 1.7;
            color: var(--text-primary);
            margin-bottom: 16px;
        }

        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .image-wrapper {
            position: relative;
            border-radius: var(--radius-sm);
            overflow: hidden;
            border: 1px solid var(--border-subtle);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .image-wrapper:hover {
            transform: scale(1.02);
            box-shadow: var(--shadow-float);
        }

        .image-wrapper img {
            width: 100%;
            height: auto;
            display: block;
        }

        .download-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.8rem;
            color: var(--text-primary);
            transition: all 0.2s;
        }

        .download-btn:hover {
            background: white;
            box-shadow: var(--shadow-card);
        }

        .ai-analyze-btn {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(218, 119, 86, 0.95);
            border: 1px solid var(--text-accent);
            border-radius: var(--radius-sm);
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.8rem;
            color: white;
            transition: all 0.2s;
            font-weight: 500;
        }

        .ai-analyze-btn:hover {
            background: var(--text-accent);
            box-shadow: var(--shadow-float);
        }

        .btn-start-analysis {
            background: linear-gradient(135deg, var(--text-accent), #e89b7d);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-card);
        }

        .btn-start-analysis:hover {
            box-shadow: var(--shadow-float);
            transform: translateY(-2px);
        }

        .btn-start-analysis:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .ai-result-card {
            background: #F7F7F5;
            border: 1px solid var(--border-subtle);
            border-left: 4px solid var(--text-accent);
            border-radius: var(--radius-md);
            padding: 20px;
            margin-top: 16px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .ai-result-title {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-primary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-result-content {
            font-size: 0.9rem;
            line-height: 1.7;
            color: var(--text-secondary);
        }

        .ai-loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-subtle);
            border-top-color: var(--text-accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* åˆ†æè¿›åº¦é¢æ¿ */
        .analysis-progress-panel {
            background: white;
            border: 2px solid var(--text-accent);
            border-radius: var(--radius-lg);
            padding: 40px;
            max-width: 600px;
            margin: 60px auto;
            box-shadow: var(--shadow-float);
            animation: fadeIn 0.3s ease;
        }

        .analysis-progress-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .analysis-progress-spinner {
            display: inline-block;
            width: 32px;
            height: 32px;
            border: 3px solid #f0f0f0;
            border-top-color: var(--text-accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .analysis-progress-steps {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .analysis-progress-step {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            margin-bottom: 12px;
            background: #f9f9f9;
            border-radius: var(--radius-md);
            transition: all 0.3s ease;
        }

        .analysis-progress-step.active {
            background: rgba(218, 119, 86, 0.1);
            border-left: 4px solid var(--text-accent);
        }

        .analysis-progress-step.completed {
            opacity: 0.6;
        }

        .analysis-progress-step-icon {
            font-size: 1.5rem;
            min-width: 32px;
            text-align: center;
        }

        .analysis-progress-step-text {
            flex: 1;
        }

        .analysis-progress-step-label {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .analysis-progress-step-desc {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .analysis-progress-stats {
            display: flex;
            gap: 24px;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border-subtle);
        }

        .analysis-progress-stat {
            flex: 1;
            text-align: center;
        }

        .analysis-progress-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-accent);
        }

        .analysis-progress-stat-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ==================== Analytics View ==================== */
        .analytics-header {
            margin-bottom: 32px;
        }

        .analytics-title {
            font-family: var(--font-serif);
            font-size: 2rem;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .analytics-subtitle {
            font-size: 0.95rem;
            color: var(--text-secondary);
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .kpi-card {
            background: var(--bg-panel);
            padding: 24px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-subtle);
            box-shadow: var(--shadow-card);
        }

        .kpi-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .kpi-value {
            font-family: var(--font-serif);
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .ai-summary {
            background-color: #F7F7F5;
            border-radius: var(--radius-md);
            padding: 24px;
            border-left: 4px solid var(--text-accent);
            margin-bottom: 32px;
        }

        .ai-summary-title {
            font-weight: 600;
            margin-bottom: 12px;
            font-size: 1rem;
            color: var(--text-primary);
        }

        .ai-summary p {
            margin: 0;
            color: var(--text-secondary);
            line-height: 1.7;
        }

        .chart-card {
            background: var(--bg-panel);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-card);
        }

        .chart-title {
            font-family: var(--font-serif);
            font-size: 1.3rem;
            margin-bottom: 24px;
            color: var(--text-primary);
        }

        .chart-placeholder {
            background: linear-gradient(180deg, rgba(255,255,255,0) 0%, rgba(240,240,240,0.3) 100%);
            height: 320px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            border: 1px dashed var(--border-subtle);
            font-size: 0.9rem;
        }

        /* ==================== Back Button ==================== */
        .back-button {
            display: inline-flex;
            align-items: center;
            background: none;
            border: none;
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 24px;
        }

        .back-button:hover {
            background: var(--bg-sidebar);
            color: var(--text-primary);
        }

        .back-button svg {
            color: var(--text-secondary);
            transition: color 0.2s ease;
        }

        .back-button:hover svg {
            color: var(--text-primary);
        }

        .analytics-dynamic-header {
            margin-bottom: 32px;
        }

        .analytics-dynamic-header h1 {
            font-family: var(--font-serif);
            font-size: 2rem;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .analytics-dynamic-header p {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .thread-summary-card-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .thread-summary-card-id {
            font-family: var(--font-sans);
            color: var(--text-accent);
            background: rgba(218, 119, 86, 0.08);
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            font-size: 0.85rem;
            font-weight: 500;
        }

        .thread-summary-card-stats {
            margin-left: 12px;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .thread-summary-card-prompt {
            color: var(--text-primary);
            font-size: 0.9rem;
            line-height: 1.6;
        }

        /* ==================== Loading Overlay ==================== */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(245, 244, 241, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        #loading-overlay.active {
            display: flex;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--border-subtle);
            border-top-color: var(--text-accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ==================== Cluster/Category Cards (for Scene Analysis) ==================== */
        .cluster-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .cluster-card {
            background: var(--bg-panel);
            padding: 24px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-subtle);
            box-shadow: var(--shadow-card);
            transition: all 0.2s ease;
        }

        .cluster-card.clickable-card {
            cursor: pointer;
        }

        .cluster-card.clickable-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-float);
            border-color: var(--text-accent);
        }

        .cluster-header {
            display: flex;
            justify-content: space_between;
            align_items: center;
            margin-bottom: 16px;
        }

        .cluster-title {
            font-family: var(--font-serif);
            font-size: 1.2rem;
            color: var(--text-primary);
            font-weight: 700;
        }

        .cluster-stat {
            background: var(--bg-sidebar);
            color: var(--text-primary);
            padding: 6px 12px;
            border-radius: var(--radius-sm);
            font-weight: 600;
            font-size: 0.9rem;
        }

        /* ==================== Breadcrumbs ==================== */
        .breadcrumb {
            display: flex;
            align_items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        .breadcrumb-item {
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.2s ease;
        }

        .breadcrumb-item:hover {
            color: var(--text-accent);
        }

        .breadcrumb-separator {
            color: var(--border-subtle);
        }

        .breadcrumb-current {
            color: var(--text-primary);
            font-weight: 600;
        }

        /* ==================== Back Button ==================== */
        .back-button {
            display: inline-flex;
            align_items: center;
            background: none;
            border: none;
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 24px;
        }

        .back-button:hover {
            background: var(--bg-sidebar);
            color: var(--text-primary);
        }

        .back-button svg {
            color: var(--text-secondary);
            transition: color 0.2s ease;
        }

        .back-button:hover svg {
            color: var(--text-primary);
        }

        /* ==================== Empty State ==================== */
        .empty-state {
            text-align: center;
            padding: 80px 40px;
            color: var(--text-secondary);
        }

        .empty-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 24px;
            opacity: 0.3;
        }

        .empty-title {
            font-family: var(--font-serif);
            font-size: 1.5rem;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .empty-text {
            font-size: 0.95rem;
            color: var(--text-secondary);
        }

        /* ==================== Analytics View Switching ==================== */
        .analytics-view {
            display: none;
        }

        .analytics-view.active {
            display: block;
        }

        /* ==================== Upload History ==================== */
        .history-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-top: 32px;
        }

        .history-card {
            background: var(--bg-panel);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: 20px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .history-card:hover {
            box-shadow: var(--shadow-float);
            border-color: var(--text-accent);
            transform: translateY(-2px);
        }

        .history-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .history-card-icon {
            font-size: 2rem;
            flex-shrink: 0;
        }

        .history-card-title {
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-primary);
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .history-card-meta {
            display: flex;
            gap: 12px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .history-card-size {
            background: #E8F4F8;
            color: #0288D1;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .history-card-actions {
            display: flex;
            gap: 8px;
        }

        .history-btn {
            flex: 1;
            padding: 8px 16px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-family: var(--font-sans);
        }

        .history-btn-primary {
            background: var(--text-accent);
            color: white;
        }

        .history-btn-primary:hover {
            background: #C76646;
            transform: translateY(-1px);
        }

        .history-btn-secondary {
            background: var(--bg-app);
            color: var(--text-primary);
            border: 1px solid var(--border-subtle);
        }

        .history-btn-secondary:hover {
            background: var(--bg-sidebar);
        }

        .history-btn-danger {
            background: #FFEBEE;
            color: #C62828;
        }

        .history-btn-danger:hover {
            background: #FFCDD2;
        }

        /* ==================== Responsive ==================== */
        @media (max-width: 1024px) {
            .app-container {
                grid-template-columns: 1fr;
            }

            .sidebar {
                display: none;
            }

            .thread-viewer {
                grid-template-columns: 1fr;
            }

            .thread-list {
                display: none;
            }
        }
    </style>
</head>
<body>

<div class="app-container">
    <!-- ==================== Sidebar ==================== -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">åˆ†æå·¥ä½œå®¤</div>
            <div class="sidebar-subtitle">CSV å¯¹è¯æŸ¥çœ‹å™¨</div>
        </div>

        <nav class="nav-section">
            <div class="nav-label">å¯¼èˆªèœå•</div>
            <div class="nav-item active" onclick="switchView('upload', event)">
                <div class="nav-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                </div>
                ä¸Šä¼ æ•°æ®
            </div>
            <div class="nav-item" id="nav-viewer" onclick="switchView('viewer', event)" style="display: none;">
                <div class="nav-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                </div>
                å¯¹è¯æŸ¥çœ‹å™¨
            </div>
            <div class="nav-item" id="nav-analytics" onclick="switchView('analytics', event)" style="display: none;">
                <div class="nav-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="20" x2="18" y2="10"></line>
                        <line x1="12" y1="20" x2="12" y2="4"></line>
                        <line x1="6" y1="20" x2="6" y2="14"></line>
                    </svg>
                </div>
                æ•°æ®åˆ†æ
            </div>
            <div class="nav-item" id="nav-history" onclick="switchView('history', event)">
                <div class="nav-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 3h18v18H3zM21 9H3M9 21V9"></path>
                        <path d="M3 3l18 18M21 3L3 21" style="opacity: 0.3"></path>
                    </svg>
                </div>
                ä¸Šä¼ å†å²
            </div>
        </nav>
    </aside>

    <!-- ==================== Main Content ==================== -->
    <main class="main-content">

        <!-- ==================== Upload View ==================== -->
        <section id="view-upload" class="view-section active">
            <div class="analytics-header">
                <h1 class="analytics-title">æ¬¢è¿ä½¿ç”¨åˆ†æå·¥ä½œå®¤</h1>
                <p class="analytics-subtitle">ä¸Šä¼ æ‚¨çš„ CSV æ–‡ä»¶ä»¥å¼€å§‹åˆ†æå¯¹è¯çº¿ç¨‹å¹¶å¯è§†åŒ–æ•°æ®æ´å¯Ÿ</p>
            </div>

            <div class="upload-zone" id="drop-area">
                <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                <div class="upload-title">æ‹–æ‹½ CSV æ–‡ä»¶åˆ°æ­¤å¤„</div>
                <div class="upload-subtitle">æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶ â€¢ æœ€å¤§æ–‡ä»¶å¤§å°ï¼š50MB</div>
                <input type="file" id="file-input" accept=".csv" style="display: none;">
            </div>

            <div class="ai-summary">
                <div class="ai-summary-title">ğŸ’¡ åŠŸèƒ½è¯´æ˜</div>
                <p><strong>å¯¹è¯æŸ¥çœ‹å™¨ï¼š</strong> æŒ‰ thread_id æµè§ˆå¯¹è¯ï¼ŒæŒ‰æ—¶é—´é¡ºåºæŸ¥çœ‹æ¶ˆæ¯ï¼Œä¸‹è½½å›¾ç‰‡ã€‚</p>
                <p><strong>æ•°æ®åˆ†æï¼š</strong> åˆ†æå¯¹è¯æ¨¡å¼ã€æ¶ˆæ¯åˆ†å¸ƒä»¥åŠ CSV æ•°æ®çš„å…³é”®æŒ‡æ ‡ã€‚</p>
            </div>
        </section>

        <!-- ==================== Thread Viewer ==================== -->
        <section id="view-viewer" class="view-section">
            <div class="thread-viewer">
                <div class="thread-list">
                    <div class="thread-list-header">
                        <div class="thread-list-title">å¯¹è¯åˆ—è¡¨</div>
                        <div class="thread-count" id="thread-count">å·²åŠ è½½ 0 ä¸ªå¯¹è¯</div>
                    </div>

                    <!-- ç­›é€‰æ  (Filter Bar) -->
                    <div class="filter-bar" id="filter-bar">
                        <button class="filter-trigger-btn" onclick="toggleFilterPanel()" id="filter-trigger-btn">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                            </svg>
                            ç­›é€‰
                        </button>
                        <div class="active-filters-list" id="active-filters-list">
                            <!-- Active chips will go here -->
                        </div>

                        <!-- ç­›é€‰é¢æ¿ (Popover) -->
                        <div class="filter-panel" id="filter-panel">
                            <div class="filter-panel-header">
                                <span>æ·»åŠ ç­›é€‰æ¡ä»¶</span>
                                <button class="icon-btn" onclick="closeFilterPanel()">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                </button>
                            </div>
                            <div class="filter-panel-body">
                                <!-- Step 1: Field List -->
                                <div class="field-list" id="filter-field-list"></div>
                                
                                <!-- Step 2: Value Selection (Hidden by default) -->
                                <div class="value-selection" id="filter-value-selection" style="display: none;">
                                    <div class="filter-back-header" onclick="showFieldList()">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"></polyline></svg>
                                        <span id="current-field-name">å­—æ®µå</span>
                                    </div>
                                    <div class="value-search">
                                        <input type="text" id="filter-value-search" placeholder="æœç´¢å€¼..." oninput="filterValuesList()">
                                    </div>
                                    <div class="value-list" id="filter-value-list"></div>
                                </div>
                            </div>
                            <div class="filter-panel-footer">
                                <button class="filter-btn" onclick="resetCurrentFilter()">é‡ç½®</button>
                                <button class="filter-btn filter-btn-primary" onclick="applyCurrentFilter()">åº”ç”¨</button>
                            </div>
                        </div>
                    </div>

                    <div id="sidebar"></div>
                </div>

                <div class="thread-content">
                    <div id="main-content" class="empty-state">
                        <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                        </svg>
                        <div class="empty-title">é€‰æ‹©ä¸€ä¸ªå¯¹è¯</div>
                        <div class="empty-text">ä»å·¦ä¾§åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªå¯¹è¯çº¿ç¨‹ä»¥æŸ¥çœ‹å†…å®¹</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ==================== Analytics View ==================== -->
        <section id="view-analytics" class="view-section">
            <!-- é™æ€æ€»è§ˆé¡µé¢ï¼ˆé»˜è®¤æ˜¾ç¤ºï¼‰-->
            <div id="analytics-overview" class="analytics-view active">
                <div class="analytics-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h1 class="analytics-title">æ•°æ®åˆ†ææ€»è§ˆ</h1>
                        <p class="analytics-subtitle">ä»æ‚¨çš„å¯¹è¯æ•°æ®ä¸­è·å–æ´å¯Ÿå’Œæ¨¡å¼</p>
                    </div>
                    <button id="btn-start-analysis" class="btn-start-analysis" onclick="startAIAnalysis()" style="display: none;">
                        ğŸ¤– å¼€å§‹ AI åˆ†æ
                    </button>
                </div>

                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-label">æ€»å¯¹è¯æ•°</div>
                        <div class="kpi-value" id="kpi-threads">-</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">æ€»æ¶ˆæ¯æ•°</div>
                        <div class="kpi-value" id="kpi-messages">-</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">å¹³å‡æ¶ˆæ¯æ•°/å¯¹è¯</div>
                        <div class="kpi-value" id="kpi-avg">-</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">åˆ†äº«å›¾ç‰‡æ•°</div>
                        <div class="kpi-value" id="kpi-images">-</div>
                    </div>
                </div>

                <div class="ai-summary">
                    <div class="ai-summary-title">ğŸ“Š å…³é”®æ´å¯Ÿ</div>
                    <p id="insight-text">åŠ è½½ CSV æ•°æ®ä»¥æŸ¥çœ‹åˆ†ææ´å¯Ÿ...</p>
                </div>

                <!-- åœºæ™¯åˆ†ç±»å…¥å£ -->
                <div style="margin-top: 40px;">
                    <h2 style="font-family: var(--font-serif); margin-bottom: 24px;">æŒ‰åœºæ™¯åˆ†æ</h2>
                    <div class="cluster-grid" id="category-grid">
                        <!-- åŠ¨æ€åŠ è½½åœºæ™¯åˆ†ç±»å¡ç‰‡ -->
                    </div>
                </div>
            </div>

            <!-- åŠ¨æ€å†…å®¹å®¹å™¨ï¼ˆç”¨äºåœºæ™¯é’»å–ï¼‰-->
            <div id="analytics-dynamic" class="analytics-view">
                <!-- é¢åŒ…å±‘å¯¼èˆª -->
                <div id="analytics-breadcrumb" class="breadcrumb"></div>

                <!-- åŠ¨æ€å†…å®¹æŒ‚è½½ç‚¹ -->
                <div id="analytics-content"></div>
            </div>
        </section>

        <!-- ==================== Upload History View ==================== -->
        <section id="view-history" class="view-section">
            <div class="analytics-header">
                <h1 class="analytics-title">ä¸Šä¼ å†å²</h1>
                <p class="analytics-subtitle">æŸ¥çœ‹å’Œç®¡ç†æ‚¨ä¸Šä¼ åˆ°äº‘ç«¯çš„ CSV æ–‡ä»¶</p>
            </div>

            <div id="history-list" class="history-grid">
                <!-- å†å²è®°å½•å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                <div class="ai-summary" style="text-align: center; padding: 60px 20px;">
                    <div style="font-size: 3rem; margin-bottom: 16px;">ğŸ“‚</div>
                    <div style="font-size: 1.1rem; color: var(--text-secondary);">æš‚æ— ä¸Šä¼ å†å²</div>
                    <p style="margin-top: 8px; color: var(--text-secondary); font-size: 0.9rem;">
                        ä¸Šä¼  CSV æ–‡ä»¶åï¼Œå†å²è®°å½•å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ
                    </p>
                </div>
            </div>
        </section>

    </main>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay">
    <div class="spinner"></div>
</div>

<script>
// ==================== Global State ====================
let globalThreads = {};
let currentView = 'upload';

// Filter state
let allCSVRows = [];  // å­˜å‚¨æ‰€æœ‰åŸå§‹ CSV è¡Œæ•°æ®
let currentFilters = {}; // å­˜å‚¨å½“å‰é€‰ä¸­çš„ç­›é€‰å€¼ { field: [values] }
let filteredThreadIds = null; // ç­›é€‰åçš„ thread IDsï¼Œnull è¡¨ç¤ºæ— ç­›é€‰

// ==================== File Upload ====================
const dropArea = document.getElementById('drop-area');
const fileInput = document.getElementById('file-input');
const loadingOverlay = document.getElementById('loading-overlay');

dropArea.addEventListener('click', () => fileInput.click());
dropArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropArea.classList.add('highlight');
});
dropArea.addEventListener('dragleave', () => dropArea.classList.remove('highlight'));
dropArea.addEventListener('drop', (e) => {
    e.preventDefault();
    dropArea.classList.remove('highlight');
    handleFile(e.dataTransfer.files[0]);
});
fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));

function handleFile(file) {
    if (!file || !file.name.endsWith('.csv')) {
        alert('è¯·ä¸Šä¼ æœ‰æ•ˆçš„ CSV æ–‡ä»¶ã€‚');
        return;
    }

    loadingOverlay.classList.add('active');
    const reader = new FileReader();
    reader.onload = (e) => {
        const csvText = e.target.result;
        processData(csvText);
        loadingOverlay.classList.remove('active');

        // æ·»åŠ åˆ°å†å²è®°å½•
        addToHistory(file, globalThreads);

        // Show navigation items
        document.getElementById('nav-viewer').style.display = 'flex';
        document.getElementById('nav-analytics').style.display = 'flex';

        // Auto-switch to viewer (without event, so we manually update nav)
        currentView = 'viewer';
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById('nav-viewer').classList.add('active');
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.getElementById('view-viewer').classList.add('active');
    };
    reader.readAsText(file);
}

// ==================== CSV Parser ====================
function processData(csvText) {
    // Remove BOM if present
    if (csvText.charCodeAt(0) === 0xFEFF) {
        csvText = csvText.substring(1);
    }

    const lines = [];
    let currentLine = '';
    let insideQuotes = false;

    // Parse CSV handling quoted fields
    for (let i = 0; i < csvText.length; i++) {
        const char = csvText[i];
        const nextChar = csvText[i + 1];

        if (char === '"' && nextChar === '"') {
            currentLine += '"';
            i++; // Skip next quote
        } else if (char === '"') {
            insideQuotes = !insideQuotes;
            currentLine += char;
        } else if ((char === '\n' || char === '\r') && !insideQuotes) {
            if (currentLine.trim()) {
                lines.push(currentLine);
            }
            currentLine = '';
            if (char === '\r' && nextChar === '\n') i++;
        } else {
            currentLine += char;
        }
    }
    if (currentLine.trim()) lines.push(currentLine);

    if (lines.length === 0) {
        alert('CSV æ–‡ä»¶ä¸ºç©ºã€‚');
        return;
    }

    // Parse header
    let headers = lines[0].split(',').map(h =>
        h.trim().replace(/^["']|["']$/g, '').replace(/ /g, '_').toLowerCase()
    );

    console.log('Headers found:', headers);

    // Parse rows
    const rows = [];
    for (let i = 1; i < lines.length; i++) {
        const row = parseCSVLine(lines[i]);
        if (row.length === headers.length) {
            const obj = {};
            headers.forEach((h, idx) => obj[h] = row[idx]);
            rows.push(obj);
        }
    }

    console.log(`Total messages: ${rows.length}`);
    organizeThreads(rows);
}

function parseCSVLine(line) {
    const result = [];
    let current = '';
    let insideQuotes = false;

    for (let i = 0; i < line.length; i++) {
        const char = line[i];
        const nextChar = line[i + 1];

        if (char === '"' && nextChar === '"') {
            current += '"';
            i++;
        } else if (char === '"') {
            insideQuotes = !insideQuotes;
        } else if (char === ',' && !insideQuotes) {
            result.push(current.trim());
            current = '';
        } else {
            current += char;
        }
    }
    result.push(current.trim());
    return result.map(field => field.replace(/^["']|["']$/g, ''));
}

// ==================== Thread Organization ====================
function organizeThreads(rows) {
    globalThreads = {};
    allCSVRows = rows; // ä¿å­˜æ‰€æœ‰åŸå§‹æ•°æ®ç”¨äºç­›é€‰

    rows.forEach(row => {
        const threadId = row.thread_id;
        if (!threadId) return;

        if (!globalThreads[threadId]) {
            globalThreads[threadId] = [];
        }

        globalThreads[threadId].push({
            timestamp: row.timestamp || '',
            text: row.text || '',
            image_list: row.image_list || '[]',
            row_num: parseInt(row.row_num) || 0
        });
    });

    // Sort messages by row_num
    Object.keys(globalThreads).forEach(threadId => {
        globalThreads[threadId].sort((a, b) => a.row_num - b.row_num);
    });

    console.log(`Unique threads: ${Object.keys(globalThreads).length}`);

    // åˆå§‹åŒ–ç­›é€‰å™¨
    initializeFilter();

    renderSidebar();
    calculateAnalytics();
}

// ==================== Sidebar Rendering ====================
function renderSidebar() {
    const sidebar = document.getElementById('sidebar');
    let threadIds = Object.keys(globalThreads);

    // åº”ç”¨ç­›é€‰
    if (filteredThreadIds !== null) {
        threadIds = threadIds.filter(id => filteredThreadIds.includes(id));
    }

    const totalCount = Object.keys(globalThreads).length;
    const filteredCount = threadIds.length;

    let countText = `å·²åŠ è½½ ${totalCount} ä¸ªå¯¹è¯`;
    if (filteredThreadIds !== null) {
        countText += ` <span class="filter-active-badge">${filteredCount} ç­›é€‰ç»“æœ</span>`;
    }

    document.getElementById('thread-count').innerHTML = countText;

    sidebar.innerHTML = threadIds.map(threadId =>
        `<div class="thread-item" onclick="selectThread('${threadId}')">${threadId}</div>`
    ).join('');
}

// ==================== Thread Selection ====================
function selectThread(threadId) {
    // Update sidebar selection
    document.querySelectorAll('.thread-item').forEach(el => el.classList.remove('active'));
    event.target.classList.add('active');

    renderThreadContent(threadId);
}

function renderThreadContent(threadId) {
    const messages = globalThreads[threadId];
    const container = document.getElementById('main-content');

    let html = `
        <div class="thread-header">
            <div class="thread-id-label">å¯¹è¯ ID</div>
            <div class="thread-id-value" onclick="copyToClipboard('${threadId}')" title="ç‚¹å‡»å¤åˆ¶">
                ${threadId}
            </div>
        </div>
    `;

    messages.forEach(msg => {
        html += `
            <div class="message-card">
                <div class="message-header">
                    <div class="message-meta">
                        <span class="turn-badge">ç¬¬ ${msg.row_num} è½®</span>
                        <span class="timestamp">${msg.timestamp}</span>
                    </div>
                </div>
                <div class="message-text">${escapeHtml(msg.text)}</div>
        `;

        // è§£æå¹¶æ˜¾ç¤ºå›¾ç‰‡
        try {
            // æ¸…ç†å’Œè§£æ image_list
            let imageListStr = msg.image_list || '[]';

            // ç§»é™¤å¯èƒ½çš„å¼•å·åŒ…è£¹
            imageListStr = imageListStr.trim().replace(/^["']|["']$/g, '');

            // å¤„ç† CSV ä¸­çš„åŒå¼•å·è½¬ä¹‰: "" -> "
            imageListStr = imageListStr.replace(/""/g, '"');

            // ä¿®å¤éæ ‡å‡†JSONæ ¼å¼ï¼š{image_url:xxx} -> {"image_url":"xxx"}
            // 1. ä¸ºå±æ€§åæ·»åŠ å¼•å·: image_url -> "image_url"
            imageListStr = imageListStr.replace(/(\{|,)\s*image_url\s*:/g, '$1"image_url":');

            // 2. ä¸ºURLå€¼æ·»åŠ å¼•å·: :https://... -> :"https://..."
            imageListStr = imageListStr.replace(/"image_url"\s*:\s*([^"}\s][^},}]*)/g, '"image_url":"$1"');

            // æ£€æŸ¥æ˜¯å¦ä¸ºç©ºæˆ–æ— æ•ˆ
            if (imageListStr && imageListStr !== '[]' && imageListStr !== '') {
                const images = JSON.parse(imageListStr);

                if (images && Array.isArray(images) && images.length > 0) {
                    html += '<div class="image-grid">';
                    images.forEach((img, idx) => {
                        if (img && img.image_url) {
                            const imageId = `img-${threadId}-${msg.row_num}-${idx}`;
                            html += `
                                <div class="image-wrapper" id="wrapper-${imageId}">
                                    <img src="${img.image_url}" alt="å›¾ç‰‡ ${idx + 1}" loading="lazy"
                                         onerror="this.parentElement.innerHTML='<div style=\\'padding:20px;color:#999;text-align:center;\\'>å›¾ç‰‡åŠ è½½å¤±è´¥</div>'">
                                    <button class="download-btn" onclick="downloadImage('${img.image_url}', 'thread-${threadId}-turn-${msg.row_num}-img-${idx + 1}.png')">
                                        â¬‡ ä¸‹è½½
                                    </button>
                                </div>
                            `;
                        }
                    });
                    html += '</div>';
                }
            }
        } catch (e) {
            console.error('Error parsing image_list for row', msg.row_num, ':', e, 'Raw value:', msg.image_list);
        }

        html += '</div>';
    });

    container.innerHTML = html;
}

// ==================== Analytics Calculation ====================
let chartDistribution, chartTimeline, chartTopThreads;

// åœºæ™¯åˆ†ææ•°æ®åº“ï¼ˆä¸‰å±‚ç»“æ„ï¼‰
const SceneDB = {};
let currentCategory = null;
let currentCluster = null;
let currentSubCluster = null;

function calculateAnalytics() {
    const threadIds = Object.keys(globalThreads);
    const totalThreads = threadIds.length;
    let totalMessages = 0;
    let totalImages = 0;
    const threadMessageCounts = {};
    const timelineData = {};

    threadIds.forEach(threadId => {
        const messages = globalThreads[threadId];
        totalMessages += messages.length;
        threadMessageCounts[threadId] = messages.length;

        messages.forEach(msg => {
            // Count images
            try {
                let imageListStr = (msg.image_list || '[]').trim().replace(/^["']|["']$/g, '').replace(/""/g, '"');
                imageListStr = imageListStr.replace(/(\{|,)\s*image_url\s*:/g, '$1"image_url":');
                imageListStr = imageListStr.replace(/"image_url"\s*:\s*([^"}\s][^},}]*)/g, '"image_url":"$1"');

                if (imageListStr && imageListStr !== '[]') {
                    const images = JSON.parse(imageListStr);
                    totalImages += images.length;
                }
            } catch (e) {}

            // Group by date for timeline
            if (msg.timestamp) {
                const date = msg.timestamp.split(' ')[0]; // Extract date part
                timelineData[date] = (timelineData[date] || 0) + 1;
            }
        });
    });

    const avgMessages = (totalMessages / totalThreads).toFixed(1);

    // Update KPIs
    document.getElementById('kpi-threads').textContent = totalThreads.toLocaleString();
    document.getElementById('kpi-messages').textContent = totalMessages.toLocaleString();
    document.getElementById('kpi-avg').textContent = avgMessages;
    document.getElementById('kpi-images').textContent = totalImages.toLocaleString();

    // Update insights
    const mostActiveThread = Object.entries(threadMessageCounts).sort((a, b) => b[1] - a[1])[0];
    const mostActiveCount = mostActiveThread ? mostActiveThread[1] : 0;

    document.getElementById('insight-text').innerHTML = `
        åœ¨åŠ è½½çš„ <strong>${totalThreads} ä¸ªå¯¹è¯çº¿ç¨‹</strong>ä¸­ï¼Œå…±åŒ…å« <strong>${totalMessages} æ¡æ¶ˆæ¯</strong>ã€‚
        å¹³å‡æ¯ä¸ªçº¿ç¨‹æœ‰ <strong>${avgMessages} æ¡æ¶ˆæ¯</strong>ã€‚
        ç”¨æˆ·å…±åˆ†äº«äº† <strong>${totalImages} å¼ å›¾ç‰‡</strong>ã€‚
        æœ€æ´»è·ƒçš„å¯¹è¯çº¿ç¨‹åŒ…å« <strong>${mostActiveCount} æ¡æ¶ˆæ¯</strong>ã€‚
    `;

    // Render charts (ç§»é™¤ï¼Œæ”¹ä¸ºåœºæ™¯åˆ†æ)
    // renderDistributionChart(threadMessageCounts);
    // renderTimelineChart(timelineData);
    // renderTopThreadsChart(threadMessageCounts);

    // æ˜¾ç¤ºåˆå§‹çŠ¶æ€ï¼ˆç­‰å¾…ç”¨æˆ·ç‚¹å‡»"å¼€å§‹åˆ†æ"ï¼‰
    renderInitialAnalyticsState();
}

// 1. Message Distribution Chart (Histogram)
function renderDistributionChart(threadMessageCounts) {
    const messageCounts = Object.values(threadMessageCounts);
    const distribution = {};

    // Group into buckets: 1-5, 6-10, 11-15, 16-20, 21+
    messageCounts.forEach(count => {
        let bucket;
        if (count <= 5) bucket = '1-5';
        else if (count <= 10) bucket = '6-10';
        else if (count <= 15) bucket = '11-15';
        else if (count <= 20) bucket = '16-20';
        else bucket = '21+';

        distribution[bucket] = (distribution[bucket] || 0) + 1;
    });

    const labels = ['1-5', '6-10', '11-15', '16-20', '21+'];
    const data = labels.map(label => distribution[label] || 0);

    const ctx = document.getElementById('chart-distribution');

    // Destroy old chart if exists
    if (chartDistribution) chartDistribution.destroy();

    chartDistribution = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'çº¿ç¨‹æ•°é‡',
                data: data,
                backgroundColor: 'rgba(218, 119, 86, 0.6)',
                borderColor: '#DA7756',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'æ¯ä¸ªçº¿ç¨‹çš„æ¶ˆæ¯æ•°é‡åˆ†å¸ƒ',
                    font: { size: 14, family: 'Inter' }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { stepSize: 1 }
                },
                x: {
                    title: {
                        display: true,
                        text: 'æ¶ˆæ¯æ•°é‡èŒƒå›´'
                    }
                }
            }
        }
    });
}

// 2. Timeline Activity Chart
function renderTimelineChart(timelineData) {
    const sortedDates = Object.keys(timelineData).sort();
    const counts = sortedDates.map(date => timelineData[date]);

    const ctx = document.getElementById('chart-timeline');

    if (chartTimeline) chartTimeline.destroy();

    chartTimeline = new Chart(ctx, {
        type: 'line',
        data: {
            labels: sortedDates,
            datasets: [{
                label: 'æ¶ˆæ¯æ•°é‡',
                data: counts,
                fill: true,
                backgroundColor: 'rgba(218, 119, 86, 0.1)',
                borderColor: '#DA7756',
                borderWidth: 2,
                tension: 0.4,
                pointRadius: 3,
                pointBackgroundColor: '#DA7756'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'æ¯æ—¥æ¶ˆæ¯æ´»è·ƒåº¦',
                    font: { size: 14, family: 'Inter' }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'æ¶ˆæ¯æ•°'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'æ—¥æœŸ'
                    }
                }
            }
        }
    });
}

// 3. Top 10 Active Threads
function renderTopThreadsChart(threadMessageCounts) {
    const sorted = Object.entries(threadMessageCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);

    const labels = sorted.map(([id, _]) => id.substring(0, 8) + '...');
    const data = sorted.map(([_, count]) => count);

    const ctx = document.getElementById('chart-top-threads');

    if (chartTopThreads) chartTopThreads.destroy();

    chartTopThreads = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'æ¶ˆæ¯æ•°',
                data: data,
                backgroundColor: 'rgba(218, 119, 86, 0.6)',
                borderColor: '#DA7756',
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'Top 10 æœ€æ´»è·ƒå¯¹è¯çº¿ç¨‹',
                    font: { size: 14, family: 'Inter' }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'æ¶ˆæ¯æ•°é‡'
                    }
                }
            }
        }
    });
}

// ==================== Scene Analysis (ä¸‰å±‚é’»å–é€»è¾‘) ====================

// æ˜¾ç¤ºåˆå§‹çŠ¶æ€ï¼ˆç­‰å¾…ç”¨æˆ·ç‚¹å‡»"å¼€å§‹åˆ†æ"ï¼‰
function renderInitialAnalyticsState() {
    const categoryGrid = document.getElementById('category-grid');
    const startButton = document.getElementById('btn-start-analysis');

    // æ˜¾ç¤ºå¼€å§‹åˆ†ææŒ‰é’®
    if (startButton) {
        startButton.style.display = 'block';
    }

    // æ˜¾ç¤ºæç¤ºä¿¡æ¯
    categoryGrid.innerHTML = `
        <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px; color: var(--text-secondary);">
            <div style="font-size: 3rem; margin-bottom: 16px;">ğŸ¤–</div>
            <h3 style="font-size: 1.2rem; color: var(--text-primary); margin-bottom: 12px;">å‡†å¤‡å¼€å§‹ AI åœºæ™¯åˆ†æ</h3>
            <p style="font-size: 0.95rem; margin-bottom: 24px;">ç‚¹å‡»å³ä¸Šè§’çš„"å¼€å§‹ AI åˆ†æ"æŒ‰é’®ï¼Œä½¿ç”¨ DeepSeek V3 è‡ªåŠ¨åˆ†æå¯¹è¯åœºæ™¯</p>
            <div style="display: inline-block; background: #f0f0f0; padding: 12px 20px; border-radius: 8px; font-size: 0.9rem;">
                ğŸ“Š å·²åŠ è½½ <strong>${Object.keys(globalThreads).length}</strong> ä¸ªå¯¹è¯ï¼Œç­‰å¾…åˆ†æ
            </div>
        </div>
    `;
}

// æ˜¾ç¤ºåˆ†æè¿›åº¦é¢æ¿
function showAnalysisProgress() {
    const categoryGrid = document.getElementById('category-grid');
    const totalThreads = Object.keys(globalThreads).length;

    categoryGrid.innerHTML = `
        <div class="analysis-progress-panel" id="analysis-progress-panel">
            <div class="analysis-progress-title">
                <div class="analysis-progress-spinner"></div>
                <span>AI åœºæ™¯åˆ†æè¿›è¡Œä¸­</span>
            </div>

            <ul class="analysis-progress-steps" id="progress-steps">
                <li class="analysis-progress-step" id="step-1">
                    <div class="analysis-progress-step-icon">ğŸ“‹</div>
                    <div class="analysis-progress-step-text">
                        <div class="analysis-progress-step-label">å‡†å¤‡æ•°æ®</div>
                        <div class="analysis-progress-step-desc">æ”¶é›† ${totalThreads} ä¸ªå¯¹è¯çš„æç¤ºè¯...</div>
                    </div>
                </li>
                <li class="analysis-progress-step" id="step-2">
                    <div class="analysis-progress-step-icon">ğŸ¤–</div>
                    <div class="analysis-progress-step-text">
                        <div class="analysis-progress-step-label">è°ƒç”¨ AI æ¨¡å‹</div>
                        <div class="analysis-progress-step-desc">ä½¿ç”¨ DeepSeek V3 è¿›è¡Œåœºæ™¯è¯†åˆ«...</div>
                    </div>
                </li>
                <li class="analysis-progress-step" id="step-3">
                    <div class="analysis-progress-step-icon">ğŸ“Š</div>
                    <div class="analysis-progress-step-text">
                        <div class="analysis-progress-step-label">å¤„ç†åˆ†ç±»ç»“æœ</div>
                        <div class="analysis-progress-step-desc">æ„å»ºåœºæ™¯æ•°æ®åº“å’Œç±»åˆ«ç»“æ„...</div>
                    </div>
                </li>
                <li class="analysis-progress-step" id="step-4">
                    <div class="analysis-progress-step-icon">âœ¨</div>
                    <div class="analysis-progress-step-text">
                        <div class="analysis-progress-step-label">æ¸²æŸ“ç»“æœ</div>
                        <div class="analysis-progress-step-desc">ç”Ÿæˆåœºæ™¯åˆ†ç±»å¡ç‰‡...</div>
                    </div>
                </li>
            </ul>

            <div class="analysis-progress-stats">
                <div class="analysis-progress-stat">
                    <div class="analysis-progress-stat-value">${totalThreads}</div>
                    <div class="analysis-progress-stat-label">å¾…åˆ†æå¯¹è¯</div>
                </div>
                <div class="analysis-progress-stat">
                    <div class="analysis-progress-stat-value" id="progress-elapsed">0s</div>
                    <div class="analysis-progress-stat-label">å·²ç”¨æ—¶é—´</div>
                </div>
                <div class="analysis-progress-stat">
                    <div class="analysis-progress-stat-value" id="progress-status">å‡†å¤‡ä¸­</div>
                    <div class="analysis-progress-stat-label">å½“å‰çŠ¶æ€</div>
                </div>
            </div>
        </div>
    `;
}

// æ›´æ–°è¿›åº¦æ­¥éª¤çŠ¶æ€
function updateProgressStep(stepNumber, status = 'active') {
    const step = document.getElementById(`step-${stepNumber}`);
    if (!step) return;

    // ç§»é™¤æ‰€æœ‰æ­¥éª¤çš„ active çŠ¶æ€
    document.querySelectorAll('.analysis-progress-step').forEach(s => {
        s.classList.remove('active');
    });

    // æ ‡è®°ä¹‹å‰çš„æ­¥éª¤ä¸ºå·²å®Œæˆ
    for (let i = 1; i < stepNumber; i++) {
        const prevStep = document.getElementById(`step-${i}`);
        if (prevStep) {
            prevStep.classList.add('completed');
            // æ›´æ”¹å›¾æ ‡ä¸ºå‹¾é€‰
            const icon = prevStep.querySelector('.analysis-progress-step-icon');
            if (icon) icon.textContent = 'âœ…';
        }
    }

    // è®¾ç½®å½“å‰æ­¥éª¤çŠ¶æ€
    if (status === 'active') {
        step.classList.add('active');
    } else if (status === 'completed') {
        step.classList.add('completed');
        const icon = step.querySelector('.analysis-progress-step-icon');
        if (icon) icon.textContent = 'âœ…';
    }

    // æ›´æ–°çŠ¶æ€æ–‡å­—
    const statusLabels = {
        1: 'å‡†å¤‡æ•°æ®',
        2: 'è°ƒç”¨ AI',
        3: 'å¤„ç†ç»“æœ',
        4: 'æ¸²æŸ“ç•Œé¢'
    };
    const statusEl = document.getElementById('progress-status');
    if (statusEl) {
        statusEl.textContent = statusLabels[stepNumber] || 'å¤„ç†ä¸­';
    }
}

// æ‰‹åŠ¨å¼€å§‹ AI åˆ†æ
async function startAIAnalysis() {
    const startButton = document.getElementById('btn-start-analysis');

    // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
    if (startButton) {
        startButton.disabled = true;
        startButton.textContent = 'ğŸ”„ åˆ†æä¸­...';
    }

    // æ˜¾ç¤ºè¿›åº¦é¢æ¿
    showAnalysisProgress();

    // å¯åŠ¨è®¡æ—¶å™¨
    const startTime = Date.now();
    const timerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const elapsedEl = document.getElementById('progress-elapsed');
        if (elapsedEl) {
            elapsedEl.textContent = `${elapsed}s`;
        }
    }, 1000);

    try {
        // æ­¥éª¤ 1: å‡†å¤‡æ•°æ®
        updateProgressStep(1, 'active');
        await new Promise(resolve => setTimeout(resolve, 500)); // çŸ­æš‚å»¶è¿Ÿè®©ç”¨æˆ·çœ‹åˆ°è¿›åº¦

        // è°ƒç”¨åŸæœ‰çš„è‡ªåŠ¨åˆ†ç±»å‡½æ•°
        await autoClassifyScenes();

        // æ­¥éª¤ 4: æ¸²æŸ“ç»“æœ
        updateProgressStep(4, 'active');
        await new Promise(resolve => setTimeout(resolve, 300));
        renderSceneCategories();

        // æ‰€æœ‰æ­¥éª¤å®Œæˆ
        updateProgressStep(4, 'completed');

    } catch (error) {
        console.error('AI åˆ†æå¤±è´¥:', error);
        const categoryGrid = document.getElementById('category-grid');
        categoryGrid.innerHTML = `
            <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #d32f2f;">
                <div style="font-size: 3rem; margin-bottom: 16px;">âš ï¸</div>
                <h3 style="font-size: 1.2rem; margin-bottom: 12px;">åˆ†æå¤±è´¥</h3>
                <p style="font-size: 0.95rem; margin-bottom: 24px;">${error.message}</p>
                <button onclick="location.reload()" style="padding: 12px 24px; background: var(--text-accent); color: white; border: none; border-radius: 8px; cursor: pointer;">
                    é‡æ–°åŠ è½½é¡µé¢
                </button>
            </div>
        `;
    } finally {
        // æ¸…é™¤è®¡æ—¶å™¨
        clearInterval(timerInterval);

        // éšè—æŒ‰é’®ï¼ˆåˆ†æå®Œæˆåä¸å†éœ€è¦ï¼‰
        if (startButton) {
            startButton.style.display = 'none';
        }
    }
}

// è‡ªåŠ¨åˆ†ç±»åœºæ™¯ï¼ˆAI å¢å¼ºç‰ˆï¼šè°ƒç”¨ Gemini API åˆ†æ promptï¼‰
async function autoClassifyScenes() {
    // æ”¶é›†æ‰€æœ‰ prompt
    updateProgressStep(1, 'active');
    const allPrompts = [];
    Object.keys(globalThreads).forEach(threadId => {
        const messages = globalThreads[threadId];
        const firstMessage = messages[0];
        if (firstMessage && firstMessage.text) {
            allPrompts.push({
                threadId: threadId,
                prompt: firstMessage.text,
                messageCount: messages.length,
                imageCount: countImagesInThread(messages)
            });
        }
    });

    console.log(`å‡†å¤‡åˆ†æ ${allPrompts.length} ä¸ªå¯¹è¯çš„ prompt...`);

    // æ­¥éª¤ 2: è°ƒç”¨ AI API è¿›è¡Œåˆ†ç±»
    updateProgressStep(2, 'active');
    try {
        const classification = await callGeminiForClassification(allPrompts);

        // æ­¥éª¤ 3: å¤„ç†åˆ†ç±»ç»“æœ
        updateProgressStep(3, 'active');
        await new Promise(resolve => setTimeout(resolve, 300)); // çŸ­æš‚å»¶è¿Ÿ

        // ä½¿ç”¨ AI è¿”å›çš„åˆ†ç±»ç»“æœæ„å»º SceneDB
        if (classification && classification.categories) {
            Object.keys(classification.categories).forEach(categoryName => {
                const category = classification.categories[categoryName];
                SceneDB[categoryName] = {
                    name: categoryName,
                    description: category.description || `${categoryName}ç›¸å…³çš„å¯¹è¯åˆ†æ`,
                    count: category.threadIds ? category.threadIds.length : 0,
                    clusters: {
                        'all': {
                            name: "å…¨éƒ¨å¯¹è¯",
                            count: category.threadIds ? category.threadIds.length : 0,
                            desc: category.insight || `${categoryName}çš„æ‰€æœ‰ç›¸å…³å¯¹è¯`,
                            threads: []
                        }
                    }
                };

                // å¡«å…… threads
                if (category.threadIds) {
                    category.threadIds.forEach(threadId => {
                        const threadData = allPrompts.find(p => p.threadId === threadId);
                        if (threadData) {
                            SceneDB[categoryName].clusters['all'].threads.push({
                                id: threadId,
                                prompt: threadData.prompt.substring(0, 200) + '...',
                                rowNum: threadData.messageCount,
                                images: threadData.imageCount
                            });
                        }
                    });
                }
            });

            console.log('AI åˆ†ç±»å®Œæˆ:', SceneDB);
        }
    } catch (error) {
        console.error('AI åˆ†ç±»å¤±è´¥ï¼Œä½¿ç”¨å…³é”®è¯å¤‡ç”¨æ–¹æ¡ˆ:', error);

        // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨å…³é”®è¯åˆ†ç±»
        await fallbackKeywordClassification(allPrompts);
    }
}

function countImagesInThread(messages) {
    let total = 0;
    messages.forEach(msg => {
        try {
            let imageListStr = (msg.image_list || '[]').trim().replace(/^["']|["']$/g, '').replace(/""/g, '"');
            imageListStr = imageListStr.replace(/(\{|,)\s*image_url\s*:/g, '$1"image_url":');
            imageListStr = imageListStr.replace(/"image_url"\s*:\s*([^"}\s][^},}]*)/g, '"image_url":"$1"');
            if (imageListStr && imageListStr !== '[]') {
                const images = JSON.parse(imageListStr);
                total += images.length;
            }
        } catch (e) {}
    });
    return total;
}

// AI åˆ†ç±»å‡½æ•°ï¼šè°ƒç”¨åç«¯ Serverless APIï¼ˆä¿æŠ¤ API Keyï¼‰
async function callGeminiForClassification(allPrompts) {
    // æ£€æµ‹è¿è¡Œç¯å¢ƒå¹¶è®¾ç½®æ­£ç¡®çš„ API URL
    let API_URL;

    if (window.location.protocol === 'file:') {
        // æœ¬åœ°æ–‡ä»¶ï¼Œä½¿ç”¨ Vercel çº¿ä¸Š APIï¼ˆå›ºå®šåŸŸåï¼Œæ°¸ä¹…æœ‰æ•ˆï¼‰
        API_URL = 'https://csv-visualizer-one.vercel.app/api/classify';
        console.log('[æœ¬åœ°æ–‡ä»¶æ¨¡å¼] ä½¿ç”¨ Vercel çº¿ä¸Š API');
    } else if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        // æœ¬åœ°å¼€å‘æœåŠ¡å™¨
        API_URL = 'http://localhost:3000/api/classify';
        console.log('[æœ¬åœ°å¼€å‘æ¨¡å¼] ä½¿ç”¨æœ¬åœ° API');
    } else {
        // Vercel ç”Ÿäº§ç¯å¢ƒ
        API_URL = '/api/classify';
        console.log('[ç”Ÿäº§ç¯å¢ƒæ¨¡å¼] ä½¿ç”¨ç›¸å¯¹è·¯å¾„ API');
    }

    console.log('[è°ƒç”¨åç«¯ API]', API_URL, `åˆ†æ ${allPrompts.length} ä¸ª prompts`);

    try {
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                prompts: allPrompts
            })
        });

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || `HTTP ${response.status}`);
        }

        const classification = await response.json();

        // å¦‚æœåç«¯è¿”å› fallback æ ‡å¿—ï¼ŒæŠ›å‡ºé”™è¯¯è§¦å‘å¤‡ç”¨æ–¹æ¡ˆ
        if (classification.fallback) {
            throw new Error('åç«¯ API è°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ');
        }

        // éªŒè¯è¿”å›æ ¼å¼
        if (!classification.categories || typeof classification.categories !== 'object') {
            throw new Error('åç«¯è¿”å›æ ¼å¼é”™è¯¯');
        }

        console.log('[AI åˆ†ç±»æˆåŠŸ]', classification);
        return classification;

    } catch (error) {
        console.error('[åç«¯ API è°ƒç”¨å¤±è´¥]', error);
        throw error; // æŠ›å‡ºé”™è¯¯ï¼Œè§¦å‘å¤‡ç”¨æ–¹æ¡ˆ
    }
}

// å¤‡ç”¨æ–¹æ¡ˆï¼šåŸºäºå…³é”®è¯çš„ç®€å•åˆ†ç±»
async function fallbackKeywordClassification(allPrompts) {
    console.log('[å¯ç”¨å…³é”®è¯åˆ†ç±»å¤‡ç”¨æ–¹æ¡ˆ]');

    // å®šä¹‰å…³é”®è¯è§„åˆ™
    const rules = {
        'æ‘„å½±ç±»': {
            keywords: ['ç…§ç‰‡', 'æ‘„å½±', 'æ‹æ‘„', 'å†™çœŸ', 'äººåƒ', 'photo', 'portrait', 'camera'],
            description: 'åŒ…å«æ‘„å½±ã€å†™çœŸã€äººåƒç›¸å…³çš„å¯¹è¯',
            insight: 'ç”¨æˆ·ä¸»è¦å…³æ³¨äººåƒæ‘„å½±å’Œå†™çœŸæ‹æ‘„åœºæ™¯'
        },
        'è®¾è®¡ç±»': {
            keywords: ['è®¾è®¡', 'æµ·æŠ¥', 'banner', 'logo', 'å“ç‰Œ', 'UI', 'UX', 'ç•Œé¢'],
            description: 'åŒ…å«å¹³é¢è®¾è®¡ã€UI/UXã€å“ç‰Œè§†è§‰ç›¸å…³çš„å¯¹è¯',
            insight: 'ç”¨æˆ·èšç„¦äºè§†è§‰è®¾è®¡å’Œå“ç‰Œåˆ›æ„'
        },
        'æ–‡æ¡ˆåˆ›ä½œ': {
            keywords: ['æ–‡æ¡ˆ', 'æ ‡é¢˜', 'å¹¿å‘Šè¯­', 'è¥é”€', 'æ¨å¹¿', 'å†…å®¹', 'å†™ä½œ'],
            description: 'åŒ…å«æ–‡æ¡ˆæ’°å†™ã€è¥é”€æ¨å¹¿ç›¸å…³çš„å¯¹è¯',
            insight: 'ç”¨æˆ·éœ€æ±‚é›†ä¸­åœ¨è¥é”€æ–‡æ¡ˆå’Œå†…å®¹åˆ›ä½œ'
        },
        'æŠ€æœ¯å’¨è¯¢': {
            keywords: ['ä»£ç ', 'ç¼–ç¨‹', 'å¼€å‘', 'bug', 'æŠ€æœ¯', 'API', 'æ•°æ®åº“', 'ç®—æ³•'],
            description: 'åŒ…å«ç¼–ç¨‹ã€æŠ€æœ¯é—®é¢˜ã€å¼€å‘å’¨è¯¢ç›¸å…³çš„å¯¹è¯',
            insight: 'ç”¨æˆ·ä¸»è¦å’¨è¯¢æŠ€æœ¯å¼€å‘å’Œç¼–ç¨‹é—®é¢˜'
        },
        'å…¶ä»–': {
            keywords: [],
            description: 'æœªèƒ½æ˜ç¡®åˆ†ç±»çš„å…¶ä»–å¯¹è¯',
            insight: 'æ¶µç›–å¤šæ ·åŒ–çš„ç”¨æˆ·éœ€æ±‚å’Œé—®é¢˜'
        }
    };

    // åˆ†ç±»é€»è¾‘
    const categories = {};
    Object.keys(rules).forEach(cat => {
        categories[cat] = {
            description: rules[cat].description,
            insight: rules[cat].insight,
            threadIds: []
        };
    });

    allPrompts.forEach(p => {
        let matched = false;
        for (let cat in rules) {
            if (cat === 'å…¶ä»–') continue;

            const keywords = rules[cat].keywords;
            const hasKeyword = keywords.some(kw =>
                p.prompt.toLowerCase().includes(kw.toLowerCase())
            );

            if (hasKeyword) {
                categories[cat].threadIds.push(p.threadId);
                matched = true;
                break;
            }
        }

        if (!matched) {
            categories['å…¶ä»–'].threadIds.push(p.threadId);
        }
    });

    // ç§»é™¤ç©ºåˆ†ç±»
    Object.keys(categories).forEach(cat => {
        if (categories[cat].threadIds.length === 0) {
            delete categories[cat];
        }
    });

    // æ„å»º SceneDB
    Object.keys(categories).forEach(categoryName => {
        const category = categories[categoryName];
        SceneDB[categoryName] = {
            name: categoryName,
            description: category.description,
            count: category.threadIds.length,
            clusters: {
                'all': {
                    name: "å…¨éƒ¨å¯¹è¯",
                    count: category.threadIds.length,
                    desc: category.insight,
                    threads: []
                }
            }
        };

        // å¡«å…… threads
        category.threadIds.forEach(threadId => {
            const threadData = allPrompts.find(p => p.threadId === threadId);
            if (threadData) {
                SceneDB[categoryName].clusters['all'].threads.push({
                    id: threadId,
                    prompt: threadData.prompt.substring(0, 200) + '...',
                    rowNum: threadData.messageCount,
                    images: threadData.imageCount
                });
            }
        });
    });

    console.log('[å…³é”®è¯åˆ†ç±»å®Œæˆ]', SceneDB);
}

// æ¸²æŸ“åœºæ™¯åˆ†ç±»å¡ç‰‡ï¼ˆLevel 0 â†’ Level 1ï¼‰
function renderSceneCategories() {
    const container = document.getElementById('category-grid');
    let html = '';

    for (let categoryKey in SceneDB) {
        const category = SceneDB[categoryKey];
        if (category.count === 0) continue;

        html += `
            <div class="cluster-card clickable-card" onclick="loadSceneCategory('${categoryKey}')">
                <div class="cluster-header">
                    <span class="cluster-title">${category.name}</span>
                    <span class="cluster-stat">${category.count}</span>
                </div>
                <p style="color: #666; font-size: 0.9rem; margin-bottom: 16px;">
                    ${category.description}
                </p>
                <div style="font-size: 0.85rem; color: var(--text-accent); font-weight:500;">
                    æŸ¥çœ‹è¯¦æƒ… â†’
                </div>
            </div>
        `;
    }

    container.innerHTML = html;
}

// Level 1: åŠ è½½æŸä¸ªåœºæ™¯åˆ†ç±»
function loadSceneCategory(categoryKey) {
    currentCategory = categoryKey;
    currentCluster = null;
    currentSubCluster = null;

    switchAnalyticsView('dynamic');
    renderSceneBreadcrumb(categoryKey);

    const category = SceneDB[categoryKey];
    const content = document.getElementById('analytics-content');

    if (!category || !category.clusters || Object.keys(category.clusters).length === 0) {
        content.innerHTML = `<div class="ai-summary">æ­¤åœºæ™¯æš‚æ— è¯¦ç»†æ•°æ®ã€‚</div>`;
        return;
    }

    let html = `
        <header class="analytics-dynamic-header">
            <h1>${category.name}</h1>
            <p>${category.description}</p>
        </header>
        <div class="cluster-grid">
    `;

    for (let clusterKey in category.clusters) {
        const cluster = category.clusters[clusterKey];
        html += `
            <div class="cluster-card clickable-card" onclick="loadSceneCluster('${categoryKey}', '${clusterKey}')">
                <div class="cluster-header">
                    <span class="cluster-title">${cluster.name}</span>
                    <span class="cluster-stat">${cluster.count}</span>
                </div>
                <p style="color: #666; font-size: 0.9rem; margin-bottom: 16px;">
                    ${cluster.desc}
                </p>
                <div style="font-size: 0.85rem; color: var(--text-accent); font-weight:500;">
                    æŸ¥çœ‹ ${cluster.threads.length} ä¸ªå¯¹è¯ â†’
                </div>
            </div>
        `;
    }

    html += `</div>`;
    content.innerHTML = html;
}

// Level 2: åŠ è½½æŸä¸ªèšç±»çš„å¯¹è¯åˆ—è¡¨
function loadSceneCluster(categoryKey, clusterKey) {
    currentCategory = categoryKey;
    currentCluster = clusterKey;

    renderSceneBreadcrumb(categoryKey, clusterKey);

    const cluster = SceneDB[categoryKey].clusters[clusterKey];
    const content = document.getElementById('analytics-content');

    let html = `
        <button class="back-button" onclick="loadSceneCategory('${categoryKey}')">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;"><path d="M15 18l-6-6 6-6"/></svg>
            è¿”å› ${SceneDB[categoryKey].name}
        </button>
        <div class="ai-summary">
            <div class="ai-summary-title">åœºæ™¯: ${cluster.name}</div>
            <p>${cluster.desc}</p>
        </div>

        <h3 class="analytics-title" style="margin-top: 32px;">å¯¹è¯åˆ—è¡¨ (${cluster.threads.length})</h3>
    `;

    cluster.threads.forEach(thread => {
        html += `
            <div class="message-card clickable-card" onclick="viewThreadFromScene('${thread.id}')">
                <div class="thread-summary-card-meta">
                    <div>
                        <span class="thread-summary-card-id">
                            #${thread.id.substring(0, 8)}...
                        </span>
                        <span class="thread-summary-card-stats">
                            ${thread.rowNum} æ¡æ¶ˆæ¯ â€¢ ${thread.images} å¼ å›¾ç‰‡
                        </span>
                    </div>
                </div>
                <div class="thread-summary-card-prompt">
                    ${thread.prompt}
                </div>
            </div>
        `;
    });

    content.innerHTML = html;
}

// ä»åœºæ™¯åˆ†æè·³è½¬åˆ°å¯¹è¯æŸ¥çœ‹å™¨
function viewThreadFromScene(threadId) {
    // åˆ‡æ¢åˆ°Thread Viewer
    switchView('viewer', null);

    // é€‰ä¸­å¯¹åº”çš„thread
    selectThread(threadId);

    // æ›´æ–°ä¾§è¾¹æ é«˜äº®
    document.querySelectorAll('.thread-item').forEach(el => {
        if (el.textContent === threadId) {
            el.classList.add('active');
        }
    });
}

// åˆ‡æ¢Analyticså­è§†å›¾
function switchAnalyticsView(view) {
    document.querySelectorAll('.analytics-view').forEach(el => el.classList.remove('active'));
    document.getElementById(`analytics-${view}`).classList.add('active');
}

// è¿”å›æ€»è§ˆ
function showAnalyticsOverview() {
    switchAnalyticsView('overview');
    currentCategory = null;
    currentCluster = null;
    currentSubCluster = null;
    renderSceneBreadcrumb();
}

// æ¸²æŸ“é¢åŒ…å±‘
function renderSceneBreadcrumb(categoryKey, clusterKey) {
    const container = document.getElementById('analytics-breadcrumb');
    let html = `<span class="breadcrumb-item" onclick="showAnalyticsOverview()">æ•°æ®æ€»è§ˆ</span>`;

    if (categoryKey && SceneDB[categoryKey]) {
        html += `<span class="breadcrumb-separator">/</span>`;
        if (!clusterKey) {
            html += `<span class="breadcrumb-current">${SceneDB[categoryKey].name}</span>`;
        } else {
            html += `<span class="breadcrumb-item" onclick="loadSceneCategory('${categoryKey}')">${SceneDB[categoryKey].name}</span>`;
        }
    }

    if (clusterKey && SceneDB[categoryKey] && SceneDB[categoryKey].clusters[clusterKey]) {
        html += `<span class="breadcrumb-separator">/</span>`;
        html += `<span class="breadcrumb-current">${SceneDB[categoryKey].clusters[clusterKey].name}</span>`;
    }

    container.innerHTML = html;
}

// ==================== View Switching ====================
function switchView(view, event) {
    currentView = view;

    // Update nav items
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    if (event && event.target) {
        event.target.classList.add('active');
    }

    // Update view sections
    document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
    document.getElementById(`view-${view}`).classList.add('active');

    // Load upload history when switching to history view
    if (view === 'history') {
        loadUploadHistory();
    }
}

// ==================== Utilities ====================
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        alert('å¯¹è¯ ID å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
    });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function downloadImage(url, filename) {
    fetch(url)
        .then(res => res.blob())
        .then(blob => {
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        })
        .catch(err => console.error('Download failed:', err));
}

// ==================== AI Image Analysis ====================
async function analyzeImage(imageUrl, imageId) {
    const wrapper = document.getElementById(`wrapper-${imageId}`);

    // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰åˆ†æç»“æœ
    const existingResult = document.getElementById(`ai-result-${imageId}`);
    if (existingResult) {
        existingResult.remove();
        return;
    }

    // åˆ›å»ºloadingçŠ¶æ€
    const loadingDiv = document.createElement('div');
    loadingDiv.id = `ai-result-${imageId}`;
    loadingDiv.className = 'ai-result-card';
    loadingDiv.innerHTML = `
        <div class="ai-result-title">
            <span class="ai-loading"></span>
            AIæ­£åœ¨åˆ†æå›¾ç‰‡...
        </div>
    `;
    wrapper.insertAdjacentElement('afterend', loadingDiv);

    try {
        // è°ƒç”¨AIè§†è§‰åˆ†æAPI
        const analysisResult = await callVisionAPI(imageUrl);

        // æ›´æ–°ç»“æœ
        loadingDiv.innerHTML = `
            <div class="ai-result-title">
                ğŸ¤– AIåˆ†æç»“æœ
            </div>
            <div class="ai-result-content">${analysisResult}</div>
        `;
    } catch (error) {
        loadingDiv.innerHTML = `
            <div class="ai-result-title" style="color: #D32F2F;">
                âš ï¸ åˆ†æå¤±è´¥
            </div>
            <div class="ai-result-content">${error.message}</div>
        `;
    }
}

async function callVisionAPI(imageUrl) {
    // è¿™é‡Œæ¥å…¥ä½ çš„AIè§†è§‰API
    // ç¤ºä¾‹ï¼šä½¿ç”¨Google Gemini Vision API

    const API_KEY = '9fe4a522-cc15-4e82-a548-3c1d57bb149d'; // æ›¿æ¢ä¸ºå®é™…çš„API Key
    const API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent';

    try {
        // å…ˆä¸‹è½½å›¾ç‰‡å¹¶è½¬æ¢ä¸ºbase64
        const imageBase64 = await fetchImageAsBase64(imageUrl);

        const response = await fetch(`${API_URL}?key=${API_KEY}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                contents: [{
                    parts: [
                        {
                            text: "è¯·è¯¦ç»†åˆ†æè¿™å¼ å›¾ç‰‡çš„å†…å®¹ï¼ŒåŒ…æ‹¬ï¼š1) å›¾ç‰‡ä¸»é¢˜å’Œå†…å®¹æè¿° 2) è§†è§‰å…ƒç´ åˆ†æï¼ˆé¢œè‰²ã€æ„å›¾ã€é£æ ¼ï¼‰3) å¦‚æœæœ‰æ–‡å­—ï¼Œè¯·è¯†åˆ«å¹¶æå– 4) å›¾ç‰‡çš„å¯èƒ½ç”¨é€”æˆ–åœºæ™¯ã€‚è¯·ç”¨ä¸­æ–‡å›ç­”ã€‚"
                        },
                        {
                            inline_data: {
                                mime_type: "image/jpeg",
                                data: imageBase64
                            }
                        }
                    ]
                }]
            })
        });

        if (!response.ok) {
            throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();

        if (data.candidates && data.candidates[0] && data.candidates[0].content) {
            return data.candidates[0].content.parts[0].text;
        } else {
            throw new Error('APIè¿”å›æ ¼å¼å¼‚å¸¸');
        }
    } catch (error) {
        console.error('Vision APIè°ƒç”¨å¤±è´¥:', error);

        // å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œè¿”å›æ¨¡æ‹Ÿåˆ†æç»“æœ
        return `
            <strong>ğŸ“¸ å›¾ç‰‡åˆ†æ (æ¼”ç¤ºæ¨¡å¼)</strong><br><br>

            <strong>å›¾ç‰‡URL:</strong> ${imageUrl.substring(0, 60)}...<br><br>

            <strong>ğŸ’¡ æç¤º:</strong> è¦å¯ç”¨çœŸå®çš„AIåˆ†æåŠŸèƒ½ï¼Œè¯·ï¼š<br>
            1. åœ¨ä»£ç ä¸­æ›¿æ¢ <code>YOUR_API_KEY</code> ä¸ºæ‚¨çš„Google Gemini APIå¯†é’¥<br>
            2. æˆ–è€…æ¥å…¥å…¶ä»–è§†è§‰AIæœåŠ¡ï¼ˆå¦‚OpenAI Vision, Claude Visionç­‰ï¼‰<br><br>

            <strong>å½“å‰é”™è¯¯:</strong> ${error.message}<br><br>

            <em>æ¼”ç¤ºæ¨¡å¼ä¸‹æ— æ³•è¿›è¡Œå®é™…åˆ†æï¼Œè¯·é…ç½®APIåä½¿ç”¨ã€‚</em>
        `;
    }
}

async function fetchImageAsBase64(imageUrl) {
    try {
        const response = await fetch(imageUrl);
        const blob = await response.blob();

        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadend = () => {
                // ç§»é™¤data:image/xxx;base64,å‰ç¼€
                const base64 = reader.result.split(',')[1];
                resolve(base64);
            };
            reader.onerror = reject;
            reader.readAsDataURL(blob);
        });
    } catch (error) {
        throw new Error(`å›¾ç‰‡åŠ è½½å¤±è´¥: ${error.message}`);
    }
}

// ==================== Upload History Management ====================
let uploadHistory = [];
let db; // IndexedDB instance

/**
 * Initialize IndexedDB
 */
async function initIndexedDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open('CSVVisualizerDB', 1);

        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
            db = request.result;
            resolve(db);
        };

        request.onupgradeneeded = (event) => {
            const db = event.target.result;
            if (!db.objectStoreNames.contains('csvData')) {
                db.createObjectStore('csvData', { keyPath: 'id' });
            }
        };
    });
}

/**
 * Save data to IndexedDB
 */
async function saveToIndexedDB(id, data) {
    if (!db) await initIndexedDB();

    return new Promise((resolve, reject) => {
        const transaction = db.transaction(['csvData'], 'readwrite');
        const store = transaction.objectStore('csvData');
        const request = store.put({ id, data });

        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
    });
}

/**
 * Get data from IndexedDB
 */
async function getFromIndexedDB(id) {
    if (!db) await initIndexedDB();

    return new Promise((resolve, reject) => {
        const transaction = db.transaction(['csvData'], 'readonly');
        const store = transaction.objectStore('csvData');
        const request = store.get(id);

        request.onsuccess = () => resolve(request.result?.data);
        request.onerror = () => reject(request.error);
    });
}

/**
 * Delete data from IndexedDB
 */
async function deleteFromIndexedDB(id) {
    if (!db) await initIndexedDB();

    return new Promise((resolve, reject) => {
        const transaction = db.transaction(['csvData'], 'readwrite');
        const store = transaction.objectStore('csvData');
        const request = store.delete(id);

        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
    });
}

/**
 * Clean old data from IndexedDB (keep only IDs in current history)
 */
async function cleanOldIndexedDBData(keepIds) {
    if (!db) await initIndexedDB();

    const transaction = db.transaction(['csvData'], 'readwrite');
    const store = transaction.objectStore('csvData');
    const request = store.getAllKeys();

    request.onsuccess = () => {
        const allKeys = request.result;
        allKeys.forEach(key => {
            if (!keepIds.includes(key)) {
                store.delete(key);
            }
        });
    };
}

/**
 * Load upload history from localStorage or API
 */
async function loadUploadHistory() {
    try {
        // åˆå§‹åŒ– IndexedDB
        await initIndexedDB();

        // ä» localStorage åŠ è½½å†å²è®°å½•å…ƒä¿¡æ¯
        const stored = localStorage.getItem('uploadHistory');
        uploadHistory = stored ? JSON.parse(stored) : [];

        renderUploadHistory();
    } catch (error) {
        console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', error);
        uploadHistory = [];
        renderUploadHistory();
    }
}

/**
 * Render upload history cards
 */
function renderUploadHistory() {
    const container = document.getElementById('history-list');

    if (uploadHistory.length === 0) {
        container.innerHTML = `
            <div class="ai-summary" style="text-align: center; padding: 60px 20px;">
                <div style="font-size: 3rem; margin-bottom: 16px;">ğŸ“‚</div>
                <div style="font-size: 1.1rem; color: var(--text-secondary);">æš‚æ— ä¸Šä¼ å†å²</div>
                <p style="margin-top: 8px; color: var(--text-secondary); font-size: 0.9rem;">
                    ä¸Šä¼  CSV æ–‡ä»¶åï¼Œå†å²è®°å½•å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ
                </p>
            </div>
        `;
        return;
    }

    container.innerHTML = uploadHistory.map((record, index) => `
        <div class="history-card" onclick="loadHistoryFile('${record.id}')">
            <div class="history-card-header">
                <div class="history-card-icon">ğŸ“Š</div>
            </div>
            <div class="history-card-title">${escapeHtml(record.fileName)}</div>
            <div class="history-card-meta">
                <span>${formatDate(record.uploadTime)}</span>
                <span class="history-card-size">${formatFileSize(record.fileSize)}</span>
            </div>
            <div class="history-card-actions" onclick="event.stopPropagation()">
                <button class="history-btn history-btn-primary" onclick="downloadHistoryFile('${record.id}')">
                    ğŸ“¥ ä¸‹è½½
                </button>
                <button class="history-btn history-btn-danger" onclick="deleteHistoryFile('${record.id}')">
                    ğŸ—‘ï¸ åˆ é™¤
                </button>
            </div>
        </div>
    `).join('');
}

/**
 * Add a file to upload history
 */
async function addToHistory(file, data) {
    const id = Date.now().toString();

    // ä¿å­˜å®Œæ•´æ•°æ®åˆ° IndexedDBï¼ˆå¤§å®¹é‡å­˜å‚¨ï¼‰
    try {
        await saveToIndexedDB(id, data);
    } catch (error) {
        console.error('ä¿å­˜åˆ° IndexedDB å¤±è´¥:', error);
    }

    // åªä¿å­˜å…ƒä¿¡æ¯åˆ° localStorageï¼ˆè½»é‡çº§ï¼‰
    const record = {
        id: id,
        fileName: file.name,
        fileSize: file.size,
        uploadTime: new Date().toISOString(),
        threadCount: Object.keys(data).length,
        r2Url: null // R2 URL å°†åœ¨ä¸Šä¼ æˆåŠŸåæ›´æ–°
    };

    uploadHistory.unshift(record); // æœ€æ–°çš„åœ¨å‰é¢

    // é™åˆ¶å†å²è®°å½•æ•°é‡ï¼ˆæœ€å¤šä¿ç•™50æ¡ï¼‰
    if (uploadHistory.length > 50) {
        uploadHistory = uploadHistory.slice(0, 50);
        // åŒæ—¶æ¸…ç† IndexedDB ä¸­çš„æ—§æ•°æ®
        cleanOldIndexedDBData(uploadHistory.map(r => r.id));
    }

    // ä¿å­˜å…ƒä¿¡æ¯åˆ° localStorage
    try {
        localStorage.setItem('uploadHistory', JSON.stringify(uploadHistory));
    } catch (error) {
        console.error('ä¿å­˜å†å²è®°å½•å…ƒä¿¡æ¯å¤±è´¥:', error);
        // å¦‚æœè¿˜æ˜¯è¶…é™ï¼Œåªä¿ç•™æœ€è¿‘5æ¡
        uploadHistory = uploadHistory.slice(0, 5);
        localStorage.setItem('uploadHistory', JSON.stringify(uploadHistory));
    }

    // å¯é€‰ï¼šåŒæ—¶ä¸Šä¼ åˆ° Cloudflare R2ï¼ˆåå°å¼‚æ­¥ï¼Œä¸é˜»å¡ç”¨æˆ·ï¼‰
    try {
        const r2Result = await uploadToR2(file);
        // æ›´æ–°è®°å½•çš„ R2 URL
        if (r2Result && r2Result.record) {
            const idx = uploadHistory.findIndex(r => r.id === id);
            if (idx !== -1) {
                uploadHistory[idx].r2Url = r2Result.record.r2Url;
                localStorage.setItem('uploadHistory', JSON.stringify(uploadHistory));
            }
        }
    } catch (error) {
        console.warn('R2 ä¸Šä¼ å¤±è´¥ï¼ˆä¸å½±å“æœ¬åœ°ä½¿ç”¨ï¼‰:', error);
    }
}

/**
 * Upload file to Cloudflare R2 (å®¢æˆ·ç«¯ç›´ä¼ ï¼Œæ— æ–‡ä»¶å¤§å°é™åˆ¶)
 */
async function uploadToR2(file) {
    try {
        console.log('[R2] å¼€å§‹å®¢æˆ·ç«¯ç›´ä¼ :', file.name, `(${formatFileSize(file.size)})`);

        // æ­¥éª¤ 1: è·å–é¢„ç­¾åä¸Šä¼  URL
        const urlResponse = await fetch('/api/get-upload-url', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                fileName: file.name,
                fileSize: file.size,
                contentType: file.type || 'text/csv',
            }),
        });

        if (!urlResponse.ok) {
            throw new Error(`è·å–ä¸Šä¼  URL å¤±è´¥: ${urlResponse.status}`);
        }

        const { uploadUrl, publicUrl, key } = await urlResponse.json();
        console.log('[R2] è·å–åˆ°é¢„ç­¾å URLï¼Œå¼€å§‹ä¸Šä¼ ...');

        // æ­¥éª¤ 2: ç›´æ¥ä¸Šä¼ åˆ° R2ï¼ˆä½¿ç”¨é¢„ç­¾å URLï¼‰
        const uploadResponse = await fetch(uploadUrl, {
            method: 'PUT',
            body: file,
            headers: {
                'Content-Type': file.type || 'text/csv',
            },
        });

        if (!uploadResponse.ok) {
            throw new Error(`R2 ä¸Šä¼ å¤±è´¥: ${uploadResponse.status}`);
        }

        console.log('[R2] æ–‡ä»¶å·²ä¸Šä¼ åˆ°äº‘ç«¯:', publicUrl);

        // è¿”å›ä¸æ—§æ ¼å¼å…¼å®¹çš„ç»“æœ
        return {
            success: true,
            record: {
                id: Date.now().toString(),
                fileName: file.name,
                fileSize: file.size,
                uploadTime: new Date().toISOString(),
                r2Url: publicUrl,
            },
        };

    } catch (error) {
        console.error('[R2] ä¸Šä¼ å¤±è´¥:', error);
        throw error;
    }
}

/**
 * Load a file from history
 */
async function loadHistoryFile(id) {
    const record = uploadHistory.find(r => r.id === id);
    if (!record) {
        alert('å†å²è®°å½•ä¸å­˜åœ¨');
        return;
    }

    try {
        // ä» IndexedDB åŠ è½½å®Œæ•´æ•°æ®
        const data = await getFromIndexedDB(id);

        if (!data) {
            alert('æ•°æ®å·²è¢«æ¸…ç†ï¼Œè¯·é‡æ–°ä¸Šä¼ æ–‡ä»¶');
            return;
        }

        // æ¢å¤æ•°æ®
        globalThreads = data;

        // åˆ‡æ¢åˆ°æŸ¥çœ‹å™¨è§†å›¾
        document.getElementById('nav-viewer').style.display = 'flex';
        document.getElementById('nav-analytics').style.display = 'flex';
        renderSidebar();
        calculateAnalytics();
        switchView('viewer', { target: document.getElementById('nav-viewer') });

        // æ˜¾ç¤ºæˆåŠŸæç¤º
        console.log(`âœ… å·²åŠ è½½æ–‡ä»¶ï¼š${record.fileName} (${record.threadCount} ä¸ªå¯¹è¯)`);
    } catch (error) {
        console.error('åŠ è½½å†å²æ–‡ä»¶å¤±è´¥:', error);
        alert('åŠ è½½å†å²æ–‡ä»¶å¤±è´¥ï¼Œè¯·é‡æ–°ä¸Šä¼ ');
    }
}

/**
 * Download a file from history
 */
async function downloadHistoryFile(id) {
    const record = uploadHistory.find(r => r.id === id);
    if (!record) {
        alert('å†å²è®°å½•ä¸å­˜åœ¨');
        return;
    }

    try {
        // ä» IndexedDB åŠ è½½æ•°æ®
        const data = await getFromIndexedDB(id);

        if (!data) {
            alert('æ•°æ®å·²è¢«æ¸…ç†ï¼Œè¯·é‡æ–°ä¸Šä¼ æ–‡ä»¶');
            return;
        }

        // å°†æ•°æ®è½¬æ¢å› CSV æ ¼å¼å¹¶ä¸‹è½½
        const csv = convertDataToCSV(data);
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = record.fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    } catch (error) {
        console.error('ä¸‹è½½å†å²æ–‡ä»¶å¤±è´¥:', error);
        alert('ä¸‹è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
}

/**
 * Delete a file from history
 */
async function deleteHistoryFile(id) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å†å²è®°å½•å—ï¼Ÿ')) {
        return;
    }

    // ä» IndexedDB åˆ é™¤æ•°æ®
    try {
        await deleteFromIndexedDB(id);
    } catch (error) {
        console.error('åˆ é™¤ IndexedDB æ•°æ®å¤±è´¥:', error);
    }

    // ä» localStorage åˆ é™¤å…ƒä¿¡æ¯
    uploadHistory = uploadHistory.filter(r => r.id !== id);
    localStorage.setItem('uploadHistory', JSON.stringify(uploadHistory));
    renderUploadHistory();
}

/**
 * Convert data object to CSV string
 */
function convertDataToCSV(data) {
    if (!data || Object.keys(data).length === 0) {
        return '';
    }

    // Get all rows from all threads
    const allRows = [];
    Object.values(data).forEach(thread => {
        thread.forEach(row => allRows.push(row));
    });

    if (allRows.length === 0) return '';

    // Get headers from first row
    const headers = Object.keys(allRows[0]);

    // Build CSV
    const csvRows = [headers.join(',')];
    allRows.forEach(row => {
        const values = headers.map(header => {
            const value = row[header] || '';
            // Escape commas and quotes
            return `"${String(value).replace(/"/g, '""')}"`;
        });
        csvRows.push(values.join(','));
    });

    return csvRows.join('\n');
}

/**
 * Format date to human-readable string
 */
function formatDate(isoString) {
    const date = new Date(isoString);
    const now = new Date();
    const diff = now - date;

    // Less than 1 minute
    if (diff < 60000) return 'åˆšåˆš';

    // Less than 1 hour
    if (diff < 3600000) {
        return `${Math.floor(diff / 60000)} åˆ†é’Ÿå‰`;
    }

    // Less than 1 day
    if (diff < 86400000) {
        return `${Math.floor(diff / 3600000)} å°æ—¶å‰`;
    }

    // Less than 7 days
    if (diff < 604800000) {
        return `${Math.floor(diff / 86400000)} å¤©å‰`;
    }

    // More than 7 days, show specific date
    return date.toLocaleDateString('zh-CN', {
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    });
}

/**
 * Format file size to human-readable string
 */
function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';

    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));

    return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
}

// ==================== Filter Functions (Claude Style) ====================

let filterPanelOpen = false;
let editingField = null; // Currently editing field in the panel

/**
 * Toggle filter panel visibility
 */
function toggleFilterPanel() {
    filterPanelOpen = !filterPanelOpen;
    const panel = document.getElementById('filter-panel');
    const btn = document.getElementById('filter-trigger-btn');
    
    if (filterPanelOpen) {
        panel.classList.add('active');
        btn.classList.add('active');
        // Reset to field list view
        showFieldList(); 
    } else {
        closeFilterPanel();
    }
}

function closeFilterPanel() {
    filterPanelOpen = false;
    document.getElementById('filter-panel').classList.remove('active');
    document.getElementById('filter-trigger-btn').classList.remove('active');
    editingField = null;
}

/**
 * Initialize filter UI with available CSV fields
 */
function initializeFilter() {
    if (allCSVRows.length === 0) return;

    // Show filter bar
    // document.getElementById('filter-bar').style.display = 'flex'; // It's flex by default in CSS

    // Get all fields
    const sampleRow = allCSVRows[0];
    const fields = Object.keys(sampleRow);
    
    // Render Field List
    const fieldList = document.getElementById('filter-field-list');
    
    const basicFields = ['thread_id', 'timestamp', 'text', 'row_num'];
    const imageFields = ['image_list'];
    const otherFields = fields.filter(f => !basicFields.includes(f) && !imageFields.includes(f));
    
    let html = '';
    
    // Helper to render items
    const renderItems = (list) => list.map(f => `
        <li class="field-item" onclick="selectFilterField('${f}')">
            <span>${f}</span>
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color:var(--border-subtle)"><polyline points="9 18 15 12 9 6"></polyline></svg>
        </li>
    `).join('');

    if (basicFields.some(f => fields.includes(f))) {
        html += `<div class="field-group-label">åŸºç¡€å­—æ®µ</div>`;
        html += renderItems(basicFields.filter(f => fields.includes(f)));
    }
    
    if (imageFields.some(f => fields.includes(f))) {
        html += `<div class="field-group-label">åª’ä½“å­—æ®µ</div>`;
        html += renderItems(imageFields.filter(f => fields.includes(f)));
    }
    
    if (otherFields.length > 0) {
        html += `<div class="field-group-label">å…¶ä»–å­—æ®µ</div>`;
        html += renderItems(otherFields);
    }
    
    fieldList.innerHTML = html;
}

/**
 * Switch to Field List View
 */
function showFieldList() {
    document.getElementById('filter-field-list').style.display = 'block';
    document.getElementById('filter-value-selection').style.display = 'none';
    editingField = null;
}

/**
 * Select a field to filter by
 */
function selectFilterField(field) {
    editingField = field;
    
    // Switch view
    document.getElementById('filter-field-list').style.display = 'none';
    document.getElementById('filter-value-selection').style.display = 'block';
    document.getElementById('current-field-name').textContent = field;
    document.getElementById('filter-value-search').value = ''; // Reset search
    
    // Populate values
    populateFilterValues(field);
}

/**
 * Populate values for the selected field
 */
function populateFilterValues(field) {
    const valueCounts = {};
    allCSVRows.forEach(row => {
        const value = (row[field] || '').toString().trim();
        if (value) {
            valueCounts[value] = (valueCounts[value] || 0) + 1;
        }
    });

    const sortedValues = Object.entries(valueCounts).sort((a, b) => b[1] - a[1]);
    const valueList = document.getElementById('filter-value-list');
    
    // Get currently selected values for this field (if any)
    const currentSelected = currentFilters[field] || [];

    valueList.innerHTML = sortedValues.map(([value, count]) => {
        const isChecked = currentSelected.includes(value) ? 'checked' : '';
        const truncatedValue = value.length > 50 ? value.substring(0, 50) + '...' : value;
        // Escape value for attribute to prevent breaking HTML
        const safeValue = value.replace(/"/g, '&quot;'); 
        
        return `
            <li class="value-item" onclick="toggleCheckbox(event)">
                <input type="checkbox" class="value-checkbox" value="${safeValue}" ${isChecked}>
                <span style="flex:1; word-break: break-all;" title="${safeValue}">${escapeHtml(truncatedValue)}</span>
                <span class="value-count">${count}</span>
            </li>
        `;
    }).join('');
}

function toggleCheckbox(e) {
    if (e.target.type !== 'checkbox') {
        const checkbox = e.currentTarget.querySelector('input[type="checkbox"]');
        checkbox.checked = !checkbox.checked;
    }
}

/**
 * Filter the value list based on search input
 */
function filterValuesList() {
    const query = document.getElementById('filter-value-search').value.toLowerCase();
    const items = document.querySelectorAll('.value-item');
    
    items.forEach(item => {
        const text = item.querySelector('span').textContent.toLowerCase();
        if (text.includes(query)) {
            item.style.display = 'flex';
        } else {
            item.style.display = 'none';
        }
    });
}

/**
 * Apply filter for current field
 */
function applyCurrentFilter() {
    if (!editingField) return;
    
    const checkboxes = document.querySelectorAll('#filter-value-list input:checked');
    const selectedValues = Array.from(checkboxes).map(cb => cb.value); // .value is already unescaped by DOM
    
    if (selectedValues.length > 0) {
        currentFilters[editingField] = selectedValues;
    } else {
        delete currentFilters[editingField];
    }
    
    runFilterLogic();
    closeFilterPanel();
}

/**
 * Reset current field filter
 */
function resetCurrentFilter() {
    if (!editingField) return;
    
    const checkboxes = document.querySelectorAll('#filter-value-list input');
    checkboxes.forEach(cb => cb.checked = false);
}

/**
 * Execute filtering logic
 */
function runFilterLogic() {
    // Check if any filters exist
    if (Object.keys(currentFilters).length === 0) {
        filteredThreadIds = null;
    } else {
        const matchingThreadIds = new Set();
        
        allCSVRows.forEach(row => {
            let matches = true;
            for (const [field, values] of Object.entries(currentFilters)) {
                const rowValue = (row[field] || '').toString().trim();
                if (!values.includes(rowValue)) {
                    matches = false;
                    break;
                }
            }
            if (matches && row.thread_id) {
                matchingThreadIds.add(row.thread_id);
            }
        });
        filteredThreadIds = Array.from(matchingThreadIds);
    }
    
    renderSidebar(); // Updates thread list
    renderActiveFilters(); // Updates chips
}

/**
 * Remove a specific filter chip
 */
function removeFilter(field) {
    delete currentFilters[field];
    runFilterLogic();
}

/**
 * Render active filter chips
 */
function renderActiveFilters() {
    const container = document.getElementById('active-filters-list');
    const fields = Object.keys(currentFilters);
    
    if (fields.length === 0) {
        container.innerHTML = '';
        return;
    }
    
    container.innerHTML = fields.map(field => {
        const values = currentFilters[field];
        let label = `${field}: `;
        if (values.length === 1) {
            label += values[0];
        } else {
            label += `${values.length} ä¸ªå€¼`;
        }
        
        return `
            <div class="filter-chip">
                <span class="filter-chip-label">${escapeHtml(label)}</span>
                <span class="filter-chip-remove" onclick="removeFilter('${field}')">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </span>
            </div>
        `;
    }).join('');
    
    // Update thread count text to show "Filtered"
    const countEl = document.getElementById('thread-count');
    if (filteredThreadIds !== null) {
        countEl.innerHTML = `å·²åŠ è½½ ${Object.keys(globalThreads).length} ä¸ªå¯¹è¯ <span class="filter-active-badge">${filteredThreadIds.length} ç­›é€‰ç»“æœ</span>`;
    }
}

/**
 * Setup click outside to close filter panel
 */
function setupFilterClickOutside() {
    document.addEventListener('click', (event) => {
        const panel = document.getElementById('filter-panel');
        const btn = document.getElementById('filter-trigger-btn');
        
        if (filterPanelOpen && panel && !panel.contains(event.target) && !btn.contains(event.target)) {
            closeFilterPanel();
        }
    });
}

// Initial setup
document.addEventListener('DOMContentLoaded', () => {
    setupFilterClickOutside();
});

</script>

</body>
</html>
